name: Database Migration

on:
  push:
    branches: [main, develop]
    paths:
      - "apps/api/src/lib/db/**"
      - "apps/api/scripts/**"
      - "apps/api/src/data/**"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "development"
        type: choice
        options:
          - development
          - staging
          - production

env:
  NODE_VERSION: "20"

jobs:
  migrate-database:
    name: Run Database Migration
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Azure Login
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run database initialization
        env:
          PGHOST: ${{ secrets.PGHOST }}
          PGPORT: ${{ secrets.PGPORT }}
          PGUSER: ${{ secrets.PGUSER }}
          PGPASSWORD: ${{ secrets.PGPASSWORD }}
          PGDATABASE: ${{ secrets.PGDATABASE }}
          PGSSLMODE: ${{ secrets.PGSSLMODE || 'require' }}
          BLOB_BASE_URL: ${{ secrets.BLOB_BASE_URL }}
        run: |
          cd apps/api
          npm run db:init:ps || npm run db:init:bash

      - name: Verify database schema
        env:
          PGHOST: ${{ secrets.PGHOST }}
          PGPORT: ${{ secrets.PGPORT }}
          PGUSER: ${{ secrets.PGUSER }}
          PGPASSWORD: ${{ secrets.PGPASSWORD }}
          PGDATABASE: ${{ secrets.PGDATABASE }}
          PGSSLMODE: ${{ secrets.PGSSLMODE || 'require' }}
        run: |
          cd apps/api
          node <<'NODE'
          const { Client } = require('pg');

          // Configure SSL based on environment variables
          const sslMode = process.env.PGSSLMODE || process.env.PGSSL_REQUIRE;
          const sslConfig = sslMode && sslMode.toLowerCase() !== 'disable'
            ? { rejectUnauthorized: true, ...(process.env.PGSSL_CERT && { ca: process.env.PGSSL_CERT }) }
            : false;

          const client = new Client({
            host: process.env.PGHOST,
            port: Number(process.env.PGPORT),
            user: process.env.PGUSER,
            password: process.env.PGPASSWORD,
            database: process.env.PGDATABASE,
            ssl: sslConfig
          });

          (async () => {
            try {
              await client.connect();
              const { rows } = await client.query('SELECT COUNT(*)::int AS count FROM listings');
              console.log('Listings count:', rows[0].count);
            } catch (err) {
              console.error('Database verification failed:', err);
              process.exit(1);
            } finally {
              await client.end();
            }
          })();
          NODE

      - name: Upload migration logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: migration-logs
          path: |
            apps/api/migration.log
            apps/api/error.log

  seed-data:
    name: Seed Database
    runs-on: ubuntu-latest
    needs: migrate-database
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Azure Login
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Seed database with sample data
        env:
          PGHOST: ${{ secrets.PGHOST }}
          PGPORT: ${{ secrets.PGPORT }}
          PGUSER: ${{ secrets.PGUSER }}
          PGPASSWORD: ${{ secrets.PGPASSWORD }}
          PGDATABASE: ${{ secrets.PGDATABASE }}
          PGSSLMODE: ${{ secrets.PGSSLMODE || 'require' }}
        run: |
          cd apps/api
          node <<'NODE'
          const fs = require('fs');
          const path = require('path');
          const { Client } = require('pg');

          // Configure SSL based on environment variables
          const sslMode = process.env.PGSSLMODE || process.env.PGSSL_REQUIRE;
          const sslConfig = sslMode && sslMode.toLowerCase() !== 'disable'
            ? { rejectUnauthorized: true, ...(process.env.PGSSL_CERT && { ca: process.env.PGSSL_CERT }) }
            : false;

          const client = new Client({
            host: process.env.PGHOST,
            port: Number(process.env.PGPORT),
            user: process.env.PGUSER,
            password: process.env.PGPASSWORD,
            database: process.env.PGDATABASE,
            ssl: sslConfig
          });

          (async () => {
            try {
              await client.connect();
              const { rows } = await client.query('SELECT COUNT(*)::int AS count FROM listings');
              const count = rows[0].count;
              if (count === 0) {
                console.log('Seeding database with sample data...');
                const listings = JSON.parse(fs.readFileSync(path.join(process.cwd(), 'src/data/listings.json'), 'utf8'));
                await client.query('BEGIN');
                for (const listing of listings) {
                  const { id, ...data } = listing;
                  const cols = Object.keys(data);
                  const placeholders = cols.map((_, i) => `$${i + 1}`).join(', ');
                  await client.query(
                    `INSERT INTO listings (${cols.join(', ')}) VALUES (${placeholders}) ON CONFLICT (id) DO NOTHING`,
                    Object.values(data)
                  );
                }
                await client.query('COMMIT');
              } else {
                console.log(`Database already has ${count} listings`);
              }
            } catch (err) {
              try { await client.query('ROLLBACK'); } catch {}
              console.error('Seeding failed:', err);
              process.exit(1);
            } finally {
              await client.end();
            }
          })();
          NODE

  notify:
    name: Notify Migration Status
    runs-on: ubuntu-latest
    needs: migrate-database
    if: always()
    steps:
      - name: Notify Teams
        uses: skitionek/notify-microsoft-teams@11e40c38c3a629ae65a985b582eca4897b01e79e # v1.0.9
        with:
          webhook_url: ${{ secrets.TEAMS_WEBHOOK }}
          message: |
            Database Migration Complete

            Environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}
            Status: ${{ job.status }}

            Migration: ${{ needs.migrate-database.result }}
            Seeding: ${{ github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/develop' && 'completed' || 'skipped' }}
            Commit: ${{ github.sha }}
            Triggered by: ${{ github.actor }}
